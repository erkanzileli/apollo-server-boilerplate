resource_types:
  - name: kubernetes
    type: docker-image
    source:
      repository: zlabjp/kubernetes-resource
      tag: "1.14"

resources:
  - name: source-code
    type: git
    source:
      branch: master
      uri: https://github.com/erkanzileli/graphql-backend

  - name: k8s
    type: kubernetes
    source:
      server: https://192.168.39.9:8443
      namespace: graphql-backend
      token: "eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJ0dGwtY29udHJvbGxlci10b2tlbi1zcHRuciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJ0dGwtY29udHJvbGxlciIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjU2MjVjYjUwLTVkNjAtMTFlOS1hNjIzLTE0MjE1NGZkNjA5OCIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTp0dGwtY29udHJvbGxlciJ9.parfgbcK2m0agSG7L5Hm8EV2RIeM3AHddXlQqf3tg0xeBwDy6QusdjuiRGfT9ay5-hP-WZ4VMufdiopbb_Xvhnp82u79x-2o3LinK7IVuJgfY-J6FqwNt3tN5i5EOvzDye82u49HV0IAffQIsGVheFVVmQjTjLC1SUXBHQU8_u670kQUxZ7GYGtrDEp63jC9U8Q7Dst8kg2mm046R5jWSOL5F-jAbH49jxyrUZeTvoO1k8MEwp42CrX4EFL3Hjs1Xfk87Xdv2T-yH1D-W5i6Pw8l_UcmmwH1k6Z8hD5fDLNLb4CKbl26xCo6JT-FDhfBqj4OaqvfW3p942gw5zE35A"
      # certificate_authority: /home/erkanzileli/.minikube/ca.crt
      insecure_skip_tls_verify: true
  - name: app-image
    type: docker-image
    source:
      repository: 192.168.1.6:5000/grapql-backend
      tag: "latest"
      insecure_registries: ["http://192.168.1.6:5000"]

jobs:
  - name: "build & push-registry"
    plan:
      - get: source-code
        trigger: true
      - put: app-image
        params:
          build: source-code
        get_params:
          skip_download: true
  - name: deploy
    plan:
      - get: source-code
        trigger: true
        passed:
          - "build & push-registry"
      - put: k8s
        params:
          kubectl: apply -f source-code/k8s/deployment.yaml
          wait_until_ready_selector: app=graphql-backend
        get_params:
          skip_download: true
    # - task: do-your-task-here
    #   config:
    #     platform: linux
    #     image_resource:
    #       type: docker-image
    #       source:
    #         repository: ubuntu
    #     run:
    #       path: bash
    #       args:
    #       - -exc
    #       - |
    #         du -s -h
